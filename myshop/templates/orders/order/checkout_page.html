{% extends "base.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}

<style>
  /* Глобальный запрет горизонтальной прокрутки (критично для мобильных) */
  /* body {
    overflow-x: hidden !important;
  } */
  .container-fluid {
    /* overflow-x: hidden; */
    max-width: 100vw;
    box-sizing: border-box;
  }

  /* Стили для checkout_page (адаптация под мобильные) */
  /* Общий контейнер: больший padding на мобильных, ограничение ширины */
  .checkout-container {
    padding: 15px;
    max-width: 100vw;
    box-sizing: border-box;
  }

  @media (max-width: 767.98px) {
    .checkout-container {
      padding: 10px;
    }
  }

  /* Форма: больший шрифт на мобильных, ограничение ширины полей */
  .checkout .form-label {
    font-size: 1rem;
  }

  .checkout textarea, .checkout input, .checkout select {
    max-width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  @media (max-width: 767.98px) {
    .checkout .form-label {
      font-size: 1.1rem;
    }

    .checkout .mb-3 {
      margin-bottom: 1.5rem !important;
    }
  }

  /* Скрываем таблицу на мобильных, показываем карточки */
  @media (max-width: 767.98px) {
    .checkout-table {
      display: none !important;
    }

    .checkout-cards {
      display: block !important;
    }
  }

  /* На десктопе показываем таблицу, скрываем карточки */
  @media (min-width: 768px) {
    .checkout-table {
      display: block !important;
    }

    .checkout-cards {
      display: none !important;
    }
  }

  /* Стили для карточек */
  .checkout-cards .card {
    margin-bottom: 15px;
    max-width: 100%;
    overflow-x: hidden;
  }

  .checkout-cards .card-title {
    font-size: 1.1rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    max-width: 100%;
    white-space: normal;
  }

  .checkout-cards .card-text {
    font-size: 0.9rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    max-width: 100%;
    white-space: normal;
  }

  /* Вертикальный скролл для карточек при >=10 товарах */
  .checkout-cards.scrollable {
    max-height: 500px;
    overflow-y: auto;
  }

  /* Стили для таблицы */
  .checkout-table table {
    table-layout: fixed;
    width: 100%;
  }

  .checkout-table th, .checkout-table td {
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
    white-space: normal;
  }

  /* Вертикальный скролл для таблицы при >=10 товарах (если нужно) */
  .checkout-table.scrollable {
    max-height: 500px;
    overflow-y: auto;
  }

  /* Кнопка: больший размер на мобильных */
  .btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
  }

  @media (max-width: 767.98px) {
    .btn-lg {
      padding: 1rem 2rem;
      font-size: 1.2rem;
    }
  }

  /* Ограничение ширины контейнеров */
  .checkout, .cart-summary {
    max-width: 100vw;
    box-sizing: border-box;
    padding: 1rem !important;
  }

  .row .col-lg-6 {
    max-width: 100%;
  }

  /* Чекбоксы и ссылки */
  .link_soglasie_na_obrabotku_danyh, .link_soglasie_na_uslovie_sotrudnichestva {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Исправление модалов: убрать modal-lg, ограничить ширину, добавить перенос текста */
  .modal-dialog {
    max-width: 95vw !important;
    width: 95vw;
  }

  .modal-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .modal-body {
    max-height: 70vh;
    overflow-y: auto;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Специально для ваших модалов */
  #uslovia_Modal .modal-dialog, #privacyPolicyModal .modal-dialog {
    max-width: 95vw;
  }
</style>

<div class="container-fluid checkout-container">
  <!-- Добавлен класс для стилей -->
  <form method="post" class="order-form">
    {% csrf_token %}
    <div class="row">
      <div class="col-lg-6 mb-3">
        <div class="checkout p-3 h-100 bg-white">
          <h1 class="section-title h5">
            <span>Оформление заказа</span>
          </h1>
          <div class="row g-3">
            <input type="hidden" name="next" value="{{ next }}" />
            <div class="form-error">{{ form.non_field_errors }}</div>
            {% for i in form %}
              {% if i == form.comment %}
                <div class="col-12">
                  <!-- Изменено на col-12 для мобильных -->
                  <div class="mb-3">
                    <label class="form-label" for="{{ i.id_for_label }}">{{ i.label }}</label>
                    {{ i }}
                  </div>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% elif i == form.passport_number %}
                <div class="col-md-6 col-12" id="passportNumberCol" style="display: none;">
                  <!-- Добавлено col-12 -->
                  <div class="mb-3">
                    <label class="form-label" for="{{ i.id_for_label }}">{{ i.label }}</label>
                    {{ i }}
                  </div>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% elif i == form.postal_code %}
                <div class="col-md-6 col-12" id="postalCodeCol" style="display: none;">
                  <!-- Добавлено col-12 -->
                  <div class="mb-3">
                    <label class="form-label" for="{{ i.id_for_label }}">{{ i.label }}</label>
                    {{ i }}
                  </div>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% elif i == form.soglasie_na_obrabotku_danyh %}
                <div class="link_soglasie_na_obrabotku_danyh">
                  {{ i }}
                  <a href="#" id="policyLink" data-bs-toggle="modal" data-bs-target="#privacyPolicyModal">{{ i.label }}</a>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% elif i == form.soglasie_na_uslovie_sotrudnichestva %}
                <div class="link_soglasie_na_uslovie_sotrudnichestva">
                  {{ i }}
                  <a href="#" id="uslovialink" data-bs-toggle="modal" data-bs-target="#uslovia_Modal">{{ i.label }}</a>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% else %}
                <div class="col-md-6 col-12">
                  <!-- Добавлено col-12 для мобильных -->
                  <div class="mb-3">
                    <label class="form-label" for="{{ i.id_for_label }}">{{ i.label }}</label>
                    {{ i }}
                  </div>
                  <div class="form-error text-danger">{{ i.errors }}</div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-3">
        {% if removed_items %}
          {% for item in removed_items %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              Товар "{{ item.title }}" (артикул: {{ item.article_number }}, размер: {{ item.size }}) был удалён из корзины, так как он больше недоступен.
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
            </div>
          {% endfor %}
        {% endif %}
        <div class="cart-summary p-3 bg-white sidebar h-100">
          <h5 class="section-title">
            <span>Общая сумма заказа</span>
          </h5>
          <!-- Таблица для десктопа -->
          <div class="checkout-table table-responsive{% if cart|length >= 10 %} scrollable{% endif %}">
            <!-- Добавлен класс для скролла -->
            <table id="cart-items-table" class="table">
              <thead>
                <tr>
                  <th>Продукт</th>
                  <th class="text-end">Цена</th>
                </tr>
              </thead>
              <tbody id="checkout-cart-tbody">
                {% for item in cart %}
                  <tr>
                    <td>
                      {{ item.title }} Арт:{{ item.article_number }} Размер:{{ item.size }}
                      <small>{{ item.price }} ₽ x {{ item.quantity }}</small>
                    </td>
                    <td class="text-end">{{ item.total_price }} ₽</td>
                    <input type="hidden" name="size" value="{{ item.size }}">
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="2" class="text-end" id="checkout-cart-total-price">
                    <h3>
                      <strong>Итого: {{ cart.get_total_price }} ₽</strong>
                    </h3>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Карточки для мобильных (скрыты на десктопе) -->
          <div class="checkout-cards{% if cart|length >= 10 %} scrollable{% endif %}" id="checkout-cart-cards">
            <!-- Добавлено id для обновления -->
            {% for item in cart %}
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title">{{ item.title }}</h6>
                  <p class="card-text">Арт: {{ item.article_number }} | Размер: {{ item.size }}</p>
                  <p class="card-text">{{ item.price }} ₽ x {{ item.quantity }} = <strong>{{ item.total_price }} ₽</strong></p>
                  <input type="hidden" name="size" value="{{ item.size }}">
                </div>
              </div>
            {% endfor %}
            <div class="text-end mt-3">
              <h3>
                <strong id="checkout-cart-total-price-mobile">Итого: {{ cart.get_total_price }} ₽</strong>
                <!-- ID для обновления -->
              </h3>
            </div>
          </div>

          <div class="d-grid mt-3">
            <button type="submit" class="btn btn-outline-dark btn-lg">Оформить</button>
            <!-- Добавлен btn-lg для мобильных -->
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Модальные окна (обновлённые) -->
<div class="modal fade" id="uslovia_Modal" data-bs-keyboard="false" tabindex="-1" aria-labelledby="uslovia_ModalLabel" aria-hidden="true" data-bs-focus="false">
  <div class="modal-dialog modal-dialog-scrollable">
    <!-- Убрали modal-lg -->
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="uslovia_ModalLabel">{{ uslovia.title }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="modal__content">
          <div>
            <div class="htmlDataBlock">{{ uslovia.description|safe }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="privacyPolicyModal" data-bs-keyboard="false" tabindex="-1" aria-labelledby="privacyPolicyModalLabel" aria-hidden="true" data-bs-focus="false">
  <div class="modal-dialog modal-dialog-scrollable">
    <!-- Убрали modal-lg -->
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="privacyPolicyModalLabel">{{ politica.title }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="modal__content">
          <div>
            <p>{{ politica.description|safe }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'jquery/jquery-3.7.1.min.js' %}"></script>
<script>
  $(document).ready(function () {
    const cartChannel = new BroadcastChannel('cart-updates');
    function updateCart(data) {
      // Обновляем таблицу для checkout_page
      if (data.html_checkout_page && $('#checkout-cart-tbody').length) {
        $('#checkout-cart-tbody').html(data.html_checkout_page);
      }
      // Обновляем итоговую сумму для десктопа
      if (data.cart_total_price) {
        $('#checkout-cart-total-price h3 strong').text(data.cart_total_price + ' ₽');
      }
      // Обновляем итоговую сумму для мобильных
      if (data.cart_total_price) {
        $('#checkout-cart-total-price-mobile').text(data.cart_total_price + ' ₽');
      }
      // Обновляем карточки для мобильных
      if (data.html_checkout_cards && $('#checkout-cart-cards').length) {
        $('#checkout-cart-cards').html(data.html_checkout_cards);
      }
      // Обновляем badge в хедере
      if (data.cart_item_count !== undefined) {
        var text = data.pluralized_text || '';
        $('#cart-item-count').html(text);
        if (data.cart_item_count === 0) {
          $('.cart-badge').addClass('d-none');
        } else {
          $('.cart-badge').removeClass('d-none');
        }
      }
      // Если корзина пуста, перенаправляем на главную
      if (data.is_empty) {
        window.location.href = '{% url "home:search" %}';
      }
    }

    cartChannel.onmessage = function (event) {
      updateCart(event.data);
    };

    // ОБНОВЛЁННАЯ ЛОГИКА ДЛЯ ИСПРАВЛЕНИЯ ДОСТУПНОСТИ МОДАЛОВ
    let lastFocusedElement;
    
    // Сохраняем элемент, открывший модал
    $('a[data-bs-toggle="modal"]').on('click', function() {
      lastFocusedElement = this;
    });

    // При начале закрытия модала: снимаем фокус с элементов внутри модала
    $('#privacyPolicyModal, #uslovia_Modal').on('hide.bs.modal', function() {
      const activeElement = document.activeElement;
      if (this.contains(activeElement)) {
        activeElement.blur();  // Принудительно снимаем фокус
      }
    });

    // После полного закрытия: переводим фокус обратно и заменяем aria-hidden на inert
    $('#privacyPolicyModal, #uslovia_Modal').on('hidden.bs.modal', function() {
      // Убираем aria-hidden и добавляем inert (если браузер поддерживает)
      $(this).removeAttr('aria-hidden');
      if ('inert' in document.createElement('div')) {  // Проверка поддержки inert
        $(this).attr('inert', '');
      }
      // Переводим фокус на элемент открытия (если сохранён)
      if (lastFocusedElement) {
        lastFocusedElement.focus();
      }
    });

    // При открытии модала: убираем inert и aria-hidden (если был добавлен ранее)
    $('#privacyPolicyModal, #uslovia_Modal').on('show.bs.modal', function() {
      $(this).removeAttr('inert aria-hidden');
    });

    // Логика для формы (без изменений)
    $('#id_delivery_method').on('change', function() {
      if ($(this).val() === 'pickup') {
        $('#passportNumberCol').hide();
        $('#postalCodeCol').hide();
      } else {
        $('#passportNumberCol').show();
        $('#postalCodeCol').show();
      }
    });

    $('#id_delivery_method').trigger('change');
  });
</script>


{% endblock %}
