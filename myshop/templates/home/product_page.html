{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.title }}{% endblock %}

{% block content %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-5 col-lg-4 mb-3">
      <div class="bg-white h-100">
        <div id="carouselExampleFade" class="carousel slide carousel-dark" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for r in product.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ r.image.url }}" class="d-block w-100" alt="..." />
              </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleFade" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-7 col-lg-8 mb-3">
      <div class="bg-white product-content p-3 h-100">
        <div class="product-title-favorites mb-0 d-flex justify-content-between align-items-center">
          <h1 class="section-title h3 mb-0"><span>{{ product.title }}</span></h1>
          <!-- <a href="#" class="btn add-favorites">
            <i class="bi bi-heart-fill me-2"></i>
            <span>В избранное</span>
          </a> -->
          <div class="productView__articles mb-0">
            <span>Артикул:</span>
            <span class="goodsModArtNumber">{{ product.article_number }}</span>
          </div>
        </div>
        <div class="product-price-article_number d-flex justify-content-between align-items-center position-relative">
          <div class="product-price mb-0" id="price-display">
            {{ price }} ₽ <!-- Устанавливаем цену по умолчанию из первого элемента -->
          </div>
          <!-- Toast-контейнер теперь внутри блока с ценой, справа -->
          <div class="toast-container position-absolute top-0 end-0 p-0">
            <div id="cart-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-body" id="toast-message"></div>
            </div>
          </div>
        </div>
        <div class="product-add2cart">
          <div class="input-group">
            <form id="add-to-cart-form" action="{% url "cart:cart_add" product.id %}" method="post">
              {% csrf_token %}
              <label for="size-select_product">Выберите количество:</label>
              <input name="quantity" type="number" class="form-control" value="{{ cart_product_form.quantity.value|default:1 }}" min="1" />
              <label for="size-select_product">Выберите размер:</label>
              <select name="size" class="form-control custom-select" id="size-select_product" aria-label="Выберите размер" {% if cart_product_form.fields.size.required %}required{% endif %}>
                <option value="" disabled selected>Выберите размер</option>
                {% for value, price in cart_product_form.fields.size.choices %}
                  <option value="{{ value }}" {% if cart_product_form.size.value == value %}selected{% endif %} data-price="{{ price }}">{{ value }}</option>
                {% endfor %}
              </select>
              {{ cart_product_form.override }}
              <button type="submit" class="btn btn-dark" value="Add to cart">
                <i class="bi bi-cart4 me-2"></i>Добавить
              </button>
            </form>
          </div>
        </div>

        <!-- <div class="row mt-3">
          <div class="col-lg-4 mb-2">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="bi bi-shield-shaded"></i>Гарантия
                </h5>
                <ul class="list-unstyled">
                  <li>Описание</li>
                  <li></li>
                  <li></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-lg-4 mb-2">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title"><i class="bi bi-truck"></i>Доставка</h5>
                <ul class="list-unstyled">
                  <li>Описание</li>
                  <li></li>
                  <li></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-lg-4 mb-2">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <i class="bi bi-credit-card"></i>Оплата
                </h5>
                <ul class="list-unstyled">
                  <li>Описание</li>
                  <li></li>
                  <li></li>
                </ul>
              </div>
            </div>
          </div>
        </div> -->

        <div class="row mt-2">
          <div class="col-12">
            <div class="nav-bottom">
              <ul class="nav nav-tabs w-100" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                    О товаре
                  </button>
                </li>
              </ul>
              <div class="tab-content mt-3" id="myTabContent">
                <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                  <p>
                    {{ product.description|safe }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script src="{% static 'jquery/jquery-3.7.1.min.js' %}"></script>  <!-- Если не подключен глобально -->
<script>
  $(document).ready(function() {
      // Функция для получения куки по имени (копия из header.html)
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }

      // Настройка CSRF для AJAX (копия из header.html)
      $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                  const csrftoken = getCookie('csrftoken');
                  if (csrftoken) {
                      xhr.setRequestHeader("X-CSRFToken", csrftoken);
                  } else {
                      console.warn('CSRF cookie not found. Ensure {% csrf_token %} is present on the page.');
                  }
              }
          }
      });

      const cartChannel = new BroadcastChannel('cart-updates');  // Канал для синхронизации

      // Инициализируем toast с кастомной задержкой и скоростью затухания (delay для задержки перед скрытием, CSS для transition)
      $('#cart-toast').toast({
          delay: 2000  // Задержка перед началом затухания (3 секунды; изменяй по вкусу, в мс)
      });

      // Обработка формы добавления в корзину через AJAX
      $('#add-to-cart-form').on('submit', function(e) {
          e.preventDefault();  // Предотвращаем обычную отправку формы
          var form = $(this);
          $.ajax({
              url: form.attr('action'),
              type: 'POST',
              data: form.serialize(),
              success: function(data) {
                  if (data.success) {
                      updateCartUI(data);  // Обновляем UI локально
                      cartChannel.postMessage(data);  // Синхронизируем с другими страницами
                      // Показываем toast-уведомление
                      $('#toast-message').text(data.message || 'Товар добавлен в корзину!');
                      $('#cart-toast').toast('show');
                  } else {
                      alert('Ошибка добавления в корзину: ' + (data.error || 'Неизвестная ошибка'));
                  }
              },
              error: function(xhr) {
                  if (xhr.status === 403) {
                      alert('Ошибка CSRF: обновите страницу и попробуйте снова.');
                  } else {
                      alert('Ошибка отправки формы');
                  }
                  console.error('AJAX error:', arguments);
              }
          });
      });

      // Функция обновления UI (копия из header.html, адаптированная)
      function updateCartUI(data) {
          if (data.cart_item_count !== undefined) {
              var total = data.cart_item_count;
              var text = data.pluralized_text || (total > 0 ? total + ' товар' : '');
              $('#cart-item-count').html(text ? text : '');
              if (total === 0) {
                  $('.cart-badge').addClass('d-none');
              } else {
                  $('.cart-badge').removeClass('d-none');
              }
              console.log('Корзина обновлена: ' + total + ' товаров');
          }
          
          // Всегда обновляем заголовок офканваса
          var titleText = data.pluralized_text ? 'В корзине: ' + data.pluralized_text : 'Ваша корзина пуста.';
          $('#offcanvasCartLabel').text(titleText);
          
          // Обновляем содержимое офканваса, если оно предоставлено
          if (data.html_offcanvas) {
              $('#offcanvasCart .offcanvas-body').html(data.html_offcanvas);
              attachCartHandlers();  // Если есть формы в офканвасе
          }
      }

      // Слушаем сообщения от других страниц (копия из header.html)
      cartChannel.onmessage = function(event) {
          updateCartUI(event.data);
      };

      // Функция attachCartHandlers (если нужно для офканваса, копия из header.html)
      function attachCartHandlers() {
          $('.offcanvas-update-form, .offcanvas-remove-form').off('submit').on('submit', function(e) {
              e.preventDefault();
              var form = $(this);
              $.ajax({
                  url: form.attr('action'),
                  type: 'POST',
                  data: form.serialize(),
                  success: function(data) {
                      if (data.success) {
                          updateCartUI(data);
                          cartChannel.postMessage(data);
                      } else {
                          alert('Ошибка обновления корзины: ' + (data.error || 'Неизвестная ошибка'));
                      }
                  },
                  error: function(xhr) {
                      if (xhr.status === 403) {
                          alert('Ошибка CSRF: обновите страницу и попробуйте снова.');
                      } else {
                          alert('Ошибка отправки формы');
                      }
                      console.error('AJAX error:', arguments);
                  }
              });
          });
      }

      // Обработка изменения размера для динамического обновления цены
      $('#size-select_product').on('change', function() {
          var selectedOption = $(this).find('option:selected');
          var price = selectedOption.data('price');
          if (price) {
              $('#price-display').text(price + ' ₽');
          }
      });
  });
</script>

{% endblock %}
