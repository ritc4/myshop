{% load custom_filters %}
{% load static %}

<header class="header">
  <div class="header-top bg-black py-1">
    <div class="container-fluid">
      <div class="row">
        <div class="col-8 col-sm-4">
          <div
            class="header-top-phone"
          >
            <a href="tel:+79187545964">
              <i class="bi bi-telephone me-2"></i>
              <span>+79187545964</span>
            </a>
          </div>
        </div>
        <div class="col-sm-4 d-none d-sm-flex justify-content-center">
          <div class="header-time-work">
            <a href="https://t.me/optssk" class="me-2" target="_blank"><i class="bi bi-telegram"></i></a>
            <a href="https://wa.me/79187545964" target="_blank"><i class="bi bi-whatsapp"></i></a>
          </div>
        </div>
        <div class="col-4 col-sm-4">
          <div
            class="header-top-account text-end"
          >
            <div class="btn-group">
              {% if user.is_authenticated %}
              <div class="dropdown">
                <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-person-circle me-2"></i><span class="account-label">{{ user.username }}</span>
                </button>
                <ul class="dropdown-menu">
                  <li><a href="{% url 'users:profile' %}" class="dropdown-item">Перейти в профиль</a></li>
                  <form action="{% url 'users:logout' %}" method="post">
                    {% csrf_token %}
                    <li><button class="dropdown-item" href="{% url 'users:logout' %}">Выйти</button></li>
                  </form>
                  {% else %}
                  <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-person-circle me-2"></i><span class="account-label">Личный кабинет</span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="{% url 'users:login' %}">Войти</a></li>
                      <li><a class="dropdown-item" href="{% url 'users:register' %}">Регистрация</a></li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--end ./header-top-account -->
  <div class="header-middle bg-light py-3">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-3 header-logo-main h-100 text-center">
          <a href="{% url 'home:home' %}" class="header-logo"
            ><img
              src="{% static 'img/logo.png' %}"
              class="img-fluid header-img-logo"
              alt=""
          /></a>
        </div>
        <div class="col-md-6 header-search h-100">
          <form action="{% url 'home:search' %}" method="get">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                name="search"
                placeholder="Поиск..."
                aria-label="Searching..."
                aria-describedby="button-Search"
              />
              <button
                class="btn btn-outline-dark"
                type="submit"
                id="button-Search"
                value="search"
              >
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>
        </div>
        <div class="col-md-3 header-cart-bottom text-end h-100">
          <div class="cart-buttons-navbar h-100">
            <!-- <a href="#" class="btn p-1">
              <i class="bi bi-heart-fill"></i>
              <span class="badge text-bg-light cart-badge rounded-circle">1</span>
            </a> -->
            <button
              class="btn p-1"
              id="cart-open"
              type="button"
              data-bs-toggle="offcanvas2"
              data-bs-target="#offcanvasCart"
              aria-controls="offcanvasCart">
              <i class="bi bi-cart4"></i>
              <span class="badge text-bg-light cart-badge rounded-circle">
                <div class="cart" id="cart-item-count">
                  {% with total_items=cart|length %}
                    {% if total_items > 0 %}
                        {{ total_items|russian_pluralize:"товар,товара,товаров" }} 
                    {% endif %}
                  {% endwith %}
                 </div>  
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
<!--end ./header-middle -->
<div class="header-bottom">
  <div class="container-fluid p-0">
    <div class="row m-0">
      <div class="col-12 p-0">
        <!-- Горизонтальная навигационная панель с Bootstrap navbar -->
        <nav class="navbar navbar-expand-lg bg-light" role="navigation">
          <div class="container-fluid p-0">
            <!-- Тогглер для мобильных (burger button) -->
            <button class="navbar-toggler ms-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Версия для десктопа (lg+): улучшенный navbar с иконками, эффектами -->
            <div class="collapse navbar-collapse d-none d-lg-block" id="navbarNav">
              <div class="menu-container header-menu w-100">
                <ul class="navbar-nav nav justify-content-center align-items-center">
                  <!-- Пункты меню для desktop с иконками и эффектами -->
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:home' %}">
                      <i class="bi bi-house-fill me-2"></i> Главная
                    </a>
                  </li>
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:delivery' %}">
                      <i class="bi bi-truck me-2"></i> Доставка
                    </a>
                  </li>
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'cart:cart_detail' %}">
                      <i class="bi bi-cart-fill me-2"></i> Корзина
                    </a>
                  </li>
  
                  <!-- Изменено: "Каталог" теперь кнопка, открывающая оффканвас -->
                  <li class="nav-item me-3">
                    <button class="btn btn-link nav-link d-flex align-items-center p-0 border-0 bg-transparent text-decoration-none" data-bs-toggle="offcanvas" data-bs-target="#catalogOffcanvas" aria-controls="catalogOffcanvas" aria-expanded="false" aria-label="Открыть каталог категорий">
                      <i class="bi bi-grid-fill me-2"></i> Каталог
                    </button>
                    <!-- Удален дропдаун с категориями из десктопа (теперь он в оффканвасе) -->
                  </li>
  
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:news' %}">
                      <i class="bi bi-newspaper me-2"></i> Новости
                    </a>
                  </li>
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:size_table' %}">
                      <i class="bi bi-table me-2"></i> Размерная таблица
                    </a>
                  </li>
                  <li class="nav-item me-3">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:reviews' %}">
                      <i class="bi bi-star-fill me-2"></i> Отзывы
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link d-flex align-items-center" href="{% url 'home:contacts' %}">
                      <i class="bi bi-telephone-fill me-2"></i> Контакты
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>
        
        <!-- Off-canvas меню для мобильных (до lg) — без изменений -->
        <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Меню</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <ul class="navbar-nav nav flex-column">
              <!-- Пункты меню для мобильной версии с иконками -->
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'home:home' %}">
                  <i class="bi bi-house-fill me-2"></i> Главная
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'home:delivery' %}">
                  <i class="bi bi-truck me-2"></i> Доставка
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'cart:cart_detail' %}">
                  <i class="bi bi-cart-fill me-2"></i> Корзина
                </a>
              </li>
              <!-- Изменено: В мобильной версии "Каталог" теперь тоже открывает оффканвас с категориями -->
              <li class="nav-item mb-2">
                <button class="btn btn-link nav-link text-white" data-bs-toggle="offcanvas" data-bs-target="#catalogOffcanvas" aria-controls="catalogOffcanvas" aria-expanded="false" aria-label="Открыть каталог категорий">
                  <i class="bi bi-grid-fill me-2"></i> Каталог
                </button>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'home:news' %}">
                  <i class="bi bi-newspaper me-2"></i> Новости
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'home:size_table' %}">
                  <i class="bi bi-table me-2"></i> Размерная таблица
                </a>
              </li>
              <li class="nav-item mb-2">
                <a class="nav-link text-white" href="{% url 'home:reviews' %}">
                  <i class="bi bi-star-fill me-2"></i> Отзывы
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="{% url 'home:contacts' %}">
                  <i class="bi bi-telephone-fill me-2"></i> Контакты
                </a>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Новый оффканвас для каталога категорий -->
        <div class="offcanvas offcanvas-start bg-light text-dark" tabindex="-1" id="catalogOffcanvas" aria-labelledby="catalogOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="catalogOffcanvasLabel">Каталог</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            {% load mptt_tags %}
            <!-- Дерево категорий, перенесенное из десктопного дропдауна -->
            <ul class="list-unstyled" id="categories-tree">
              {% recursetree categories %}
                <li class="mb-2">
                  <div class="d-flex align-items-center justify-content-between">
                    <a 
                      href="{{ node.get_absolute_url }}" 
                      class="d-flex align-items-center text-decoration-none flex-grow-1 p-2 rounded hover-link text-dark"
                    >
                      {{ node.name }}
                    </a>
                    {% if not node.is_leaf_node %}
                      <button 
                        class="btn btn-link ms-auto p-0 d-flex align-items-center"
                        data-bs-toggle="collapse" 
                        data-bs-target="#offcanvas-collapse-{{ node.id }}" 
                        aria-expanded="false"
                        aria-controls="offcanvas-collapse-{{ node.id }}"
                        onclick="event.stopPropagation();"
                      >
                        <i class="bi bi-chevron-right"></i> 
                      </button>
                    {% endif %}
                  </div>
                  {% if not node.is_leaf_node %}
                    <ul class="children collapse list-unstyled ms-3" id="offcanvas-collapse-{{ node.id }}">
                      {{ children }}
                    </ul>
                  {% endif %}
                </li>
              {% endrecursetree %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- Toast-контейнер для уведомлений (Bootstrap) -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="cart-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-message"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрыть"></button>
    </div>
  </div>
</div>
</header>
<!--end ./header-bottom --> 

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart" aria-labelledby="offcanvasCartLabel" data-offcanvas-url="{% url 'cart:cart_detail' %}?partial=offcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasCartLabel">
      {% with total_items=cart|length %}
        {% if total_items > 0 %}
          В корзине: {{ total_items|russian_pluralize:"товар,товара,товаров" }}
        {% else %}
          Ваша корзина пуста.
        {% endif %}
      {% endwith %}
    </h5>

    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <!-- УБРАЛИ initial include: теперь content загружается при открытии -->
  <div class="offcanvas-body">
    <!-- Здесь будет загружаться partial через JS -->
  </div>
</div>



<script src="{% static 'jquery/jquery-3.7.1.min.js' %}"></script>
<script>
  $(document).ready(function() {
      // Функция для получения куки по имени
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      window.getCookie = getCookie;  // Делаем глобальной

            // Функция для показа toast
      function showToast(message) {
          $('#toast-message').text(message);
          var toast = new bootstrap.Toast($('#cart-toast'));
          toast.show();
      }

      // Настройка CSRF для всех AJAX-запросов с использованием куки
      $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                  const csrftoken = getCookie('csrftoken');
                  if (csrftoken) {
                      xhr.setRequestHeader("X-CSRFToken", csrftoken);
                  } else {
                      console.warn('CSRF cookie not found. Ensure {% csrf_token %} is present on the page.');
                  }
              }
          }
      });

      const cartChannel = new BroadcastChannel('cart-updates');
      window.cartChannel = cartChannel;  // Делаем глобальной

      var offcanvasUrl = "{% url 'cart:cart_detail' %}?partial=offcanvas";
  
      $('#offcanvasCart').on('show.bs.offcanvas', function() {
          $.ajax({
              url: offcanvasUrl,
              type: 'GET',
              success: function(data) {
                  $('#offcanvasCart .offcanvas-body').html(data.html);
                  attachCartHandlers();
              },
              error: function() { 
                  alert('Ошибка загрузки корзины'); 
                  console.error('AJAX error:', arguments);
              }
          });
      });
      
      function attachCartHandlers() {
          $('.offcanvas-update-form, .offcanvas-remove-form').off('submit').on('submit', function(e) {
              e.preventDefault();
              var form = $(this);
              $.ajax({
                  url: form.attr('action'),
                  type: 'POST',
                  data: form.serialize(),  // Убрали добавление токена — он теперь в заголовке
                  success: function(data) {
                      if (data.success) {
                          updateCartUI(data);
                          cartChannel.postMessage(data);  // Отправляем сообщение другим страницам
                      } else {
                          alert('Ошибка обновления корзины: ' + (data.error || 'Неизвестная ошибка'));
                      }
                  },
                  error: function(xhr) { 
                      if (xhr.status === 403) {
                          alert('Ошибка CSRF: обновите страницу и попробуйте снова.');
                      } else {
                          alert('Ошибка отправки формы'); 
                      }
                      console.error('AJAX error:', arguments);
                  }
              });
          });
      }
      window.attachCartHandlers = attachCartHandlers;  // Делаем глобальной
      
      function updateCartUI(data) {
          if (data.cart_item_count !== undefined) {
              var total = data.cart_item_count;
              var text = data.pluralized_text || (total > 0 ? total + ' товар' : '');
              $('#cart-item-count').html(text ? text : '');
              if (total === 0) {
                  $('.cart-badge').addClass('d-none');
              } else {
                  $('.cart-badge').removeClass('d-none');
              }
              console.log('Корзина обновлена: ' + total + ' товаров');
          }

                // Добавлено: показ toast'ов для removed_items при AJAX
          if (data.removed_items && data.removed_items.length > 0) {
              data.removed_items.forEach(function(item) {
                  showToast(`Товар "${item.title}" (артикул: ${item.article_number}, размер: ${item.size}) был удалён из корзины.`);
              });
          }
          
          // УБРАЛИ условие: всегда обновляем заголовок офканваса
          var titleText = data.pluralized_text ? 'В корзине: ' + data.pluralized_text : 'Ваша корзина пуста.';
          $('#offcanvasCartLabel').text(titleText);
          
          // Обновляем офканвас с новым HTML
          if (data.html_offcanvas) {
              $('#offcanvasCart .offcanvas-body').html(data.html_offcanvas);
              attachCartHandlers();
          }
      }
      window.updateCartUI = updateCartUI;  // Делаем глобальной
      
      // Слушаем сообщения от других страниц
      cartChannel.onmessage = function(event) {
          updateCartUI(event.data);
      };
      
      function loadOffcanvasPartial() {
          $.ajax({
              url: offcanvasUrl,
              type: 'GET',
              success: function(data) {
                  $('#offcanvasCart .offcanvas-body').html(data.html);
                  attachCartHandlers();
              },
              error: function() { alert('Ошибка перезагрузки корзины'); }
          });
      }
  });
</script>

  

